# Aly Lamp

A TypeScript-based MQTT to LIFX bridge that controls LIFX smart bulbs based on RFID card readings from an M5Stack device.

## Overview

This project connects to an MQTT broker to listen for RFID card readings and automatically changes LIFX bulb colors based on the detected cards. Each RFID card UID generates a unique color, creating an interactive lighting experience.

## Features

- üè∑Ô∏è **RFID-triggered lighting**: Scan RFID cards to change lamp colors
- üé® **Dynamic color generation**: Automatically generates colors from RFID UIDs
- üåà **Custom color mapping**: Define specific colors for known RFID cards
- üì° **MQTT integration**: Listens to M5Stack RFID readings via MQTT
- üí° **LIFX control**: Uses broadcast commands for fast, simultaneous bulb control
- üîí **Environment variables**: Secure credential management
- üìù **Full TypeScript**: Complete type safety and IntelliSense support

## Architecture

```
M5Stack RFID Reader ‚Üí MQTT Broker ‚Üí Aly Lamp ‚Üí LIFX Bulbs
                      (homebridge.local)     (LAN broadcast)
```

## Prerequisites

- Node.js 12+
- LIFX bulbs on the same network
- MQTT broker (configured for `homebridge.local:1883`)
- M5Stack or similar device publishing RFID data to `m5/rfid` topic

## Installation

1. **Clone the repository**

   ```bash
   git clone https://github.com/mpolichette/aly-lamp.git
   cd aly-lamp
   ```

2. **Install dependencies**

   ```bash
   npm install
   ```

3. **Configure environment variables**

   ```bash
   cp .env.example .env
   # Edit .env with your MQTT credentials
   ```

4. **Build the project**
   ```bash
   npm run build
   ```

## Configuration

### Environment Variables

Create a `.env` file with your MQTT broker credentials:

```env
MQTT_USERNAME=your_mqtt_username
MQTT_PASSWORD=your_mqtt_password
```

### Color Mapping

Edit `src/color-map.ts` to define specific colors for known RFID cards:

```typescript
export const colorMap: Record<string, LifxLanColorCSS> = {
  "1234ABCD": { css: "blue", brightness: 0.8 },
  "5678EFGH": { css: "red", brightness: 1.0, kelvin: 3500 },
  // Add your RFID UIDs here
};
```

## Usage

### Development Mode

```bash
npm run dev          # Build and run with auto-restart
```

### Production Mode

```bash
npm run build        # Compile TypeScript
npm start           # Run compiled JavaScript
```

### With Environment Variables

```bash
MQTT_USERNAME=myuser MQTT_PASSWORD=mypass npm start
```

## How It Works

1. **MQTT Connection**: Connects to the MQTT broker and subscribes to `m5/rfid`
2. **RFID Detection**: Receives RFID card UIDs from M5Stack device
3. **Color Resolution**:
   - Checks `colorMap` for predefined colors
   - Generates RGB color from UID if not found
4. **LIFX Control**: Broadcasts color commands to all LIFX bulbs on the network

### Color Generation Algorithm

For unknown RFID cards, colors are generated by:

- Taking the first 6 hex characters of the UID
- Converting to RGB values (2 chars each for R, G, B)
- Creating CSS color: `rgb(r, g, b)`

Example: UID `53FB78...` ‚Üí RGB(83, 251, 120) ‚Üí Light green

## API Reference

### Types

- **LifxLanColorCSS**: CSS-based color definition
- **LifxLanColorHSB**: HSB color values
- **LifxLanColorRGB**: RGB color values
- **LifxLanColor**: Union of all color types

### Key Functions

- `generateColorFromUID(uid: string)`: Creates color from RFID UID
- `setLampColor(color: LifxLanColorCSS)`: Broadcasts color to LIFX bulbs

## Scripts

| Command         | Description                       |
| --------------- | --------------------------------- |
| `npm run build` | Compile TypeScript to JavaScript  |
| `npm run dev`   | Build and run in development mode |
| `npm start`     | Run compiled application          |

## Dependencies

- **mqtt**: MQTT client for broker communication
- **node-lifx-lan**: LIFX bulb control via LAN protocol
- **dotenv**: Environment variable management
- **typescript**: TypeScript compiler and tooling

## Troubleshooting

### Common Issues

**MQTT Connection Failed**

- Verify broker is running on `homebridge.local:1883`
- Check username/password in `.env` file
- Ensure network connectivity

**No LIFX Bulbs Found**

- Confirm bulbs are on the same network
- Check that bulbs are powered on and connected to WiFi
- Verify LAN protocol is enabled on bulbs

**RFID Not Triggering**

- Check M5Stack is publishing to `m5/rfid` topic
- Verify MQTT message format
- Monitor console for received messages
